---
platform: linux

caches:
  - path: $HOME/.gradle/
  - path: $HOME/.m2/repository
  - path: $HOME/.android/sdk/cmdline-tools/bin

params:
  TERM: dumb
  PROJECT_ARN: arn:aws:devicefarm:us-west-2:944572984736:project:a202796d-364d-4917-96b7-52196f6ae4d8
  DEVICE_POOL_ARN: arn:aws:devicefarm:us-west-2:944572984736:devicepool:a202796d-364d-4917-96b7-52196f6ae4d8/59f56329-351a-4f26-8fb9-3f68aa0f0326

inputs:
  - name: pr
outputs:
  - name: reports
  - name: generatedAPK
image_resource:
  type: docker-image
  source:
    repository: darkgeat/android-studio-gitlab-ci
    tag: '3.1.1'
run:
  path: sh
  user: root
  args:
    - -c
    - |
      apt-get install jq
      aws configure import --csv ci/scripts/rootkey.csv
      aws configure set region us-west-2

      aws devicefarm create-upload --project-arn "$PROJECT_ARN" --name app.apk --type ANDROID_APP --output json > /android/app-debug-upload.txt

      ANDROID_APP_URL=$(jq -r '.url' /android/app-debug-upload.txt)
      ANDROID_APP_ARN=$(jq -r '.arn' /android/app-debug-upload.txt)
      curl -T /android/app-debug.apk $ANDROID_APP_URL

