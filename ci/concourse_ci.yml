jobs:
  - name: test
    max_in_flight: 1
    public: true
    plan:
      - get: resource-tutorial
        trigger: true
      - task: run-test-staging
        file: resource-tutorial/ci/unit_testing.yml

  - name: build
    max_in_flight: 1
    public: true
    plan:
      - get: resource-tutorial
        trigger: true
        passed: [ test ]
      - task: run-build-staging
        file: resource-tutorial/ci/build_staging.yml
      - put: distribution_appcenter
        inputs:
          - generatedAPK
        params:
          path: generatedAPK
          binary_name: app-debug.apk

  - name: create-file-slack
    plan:
      - task: make-a-file
        config:
          platform: linux
          image_resource:
            type: registry-image
            source: { repository: busybox }
          run:
            path: sh
            args:
              - -c
              - |
                ls -la
                echo '[{"color":"#4CAF50","blocks":[{"text":{"text":"*ThiveMarketTest*","type":"mrkdwn"},"type":"section"},{"type":"section","fields":[{"text":"*Job:*\nbuild","type":"mrkdwn"},{"text":"*State:*\nSUCCESS","type":"mrkdwn"},{"text":"*Message:*\nThe build is successfully created","type":"mrkdwn"},{"text":"*Version:*\n1.0","type":"mrkdwn"}]}]}]' > ./files/created_file.json
          outputs:
            - name: files
      - task: read-file
        config:
          platform: linux
          image_resource:
            type: registry-image
            source: { repository: busybox }
          inputs:
            - name: files
          run:
            path: cat
            args:
              - ./files/created_file.json
        on_success:
          put: slack-alert
          params:
            text: "Build ${BUILD_PIPELINE_NAME}/${BUILD_JOB_NAME} #${BUILD_NAME} successful - ${ATC_EXTERNAL_URL}/teams/main/pipelines/${BUILD_PIPELINE_NAME}/jobs/${BUILD_JOB_NAME}/builds/${BUILD_NAME}"
            attachments_file: ./files/created_file.json

  - name: notify-slack
    plan:
      - put: slack-alert
        params:
          channel: ((slack-channel))
          attachment_file: app/build/outputs/test/testDebugUnitTest/index.html

#############
# RESOURCES #
#############
resources:
  - icon: github
    name: resource-tutorial
    type: git
    source:
      uri: https://github.com/giovas17/ComposeExample.git
      branch: feature/adding_concourse_ci

  #- icon: github
  #  name: resource-tutorial-pull-request
  #  type: pull-request
  #  source:
  #    uri: https://github.com/giovas17/ComposeExample.git
  #    branch: develop

  - name: slack-alert
    type: slack-notification
    source:
      url: ((slack-hook-url))

  - name: distribution_appcenter
    type: appcenter
    source:
      api_token: ((appcenter-api_token))
      owner: ((appcenter-owner))
      app_name: ((appcenter-app_name))
      group_id: ((appcenter-group_id))

##################
# RESOURCE_TYPES #
##################
resource_types:
  - name: slack-notification
    type: docker-image
    source:
      repository: cfcommunity/slack-notification-resource
      tag: latest

  - name: appcenter
    type: docker-image
    source:
      repository: tomoyukim/concourse-appcenter-resource
      tag: latest

  #- name: pull-request
  #  type: docker-image
  #  source:
  #    repository: jtarchie/pr